////CREACION MOVIDAS CN/////
aws configure

cd "C:\Users\abelr\OneDrive\Escritorio\xxxxxxx"

aws ecr get-login-password --region us-east-1 `
| docker login --username AWS --password-stdin 905418226902.dkr.ecr.us-east-1.amazonaws.com


si no existe: 
aws ecr create-repository `
  --repository-name contacts-app `
  --region us-east-1

y después (o si existe el repo):
aws ecr describe-repositories `
  --repository-names contacts-app `
  --region us-east-1

docker build -t contacts-app:build .


comprobar que se creo: docker images



docker tag contacts-app:build `
  905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-app:latest

docker push 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-app:latest

cd ./deploy

aws cloudformation deploy `
  --stack-name contacts-dynamo `
  --template-file dynamodb.yml `
  --parameter-overrides TableName=contacts `
  --region us-east-1

comprobar: aws dynamodb list-tables --region us-east-1

aws cloudformation deploy `
   --stack-name contacts-main-2 `
   --template-file main.yml `
   --capabilities CAPABILITY_NAMED_IAM `
   --parameter-overrides `
     VpcId=vpc-037068fa546c4e4d6 `
     PrivateSubnets="subnet-0b3dd591c6f7fc8e6,subnet-0aa739d9a05f4cf98" `
     VpcCidr=172.31.64.0/20 `
     ContainerImage=905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-app:latest `
     DesiredCount=1 `
     AwsRegion=us-east-1 `
     TableName=contacts `
     TaskRoleArn=arn:aws:iam::905418226902:role/LabRole `
     ExecutionRoleArn=arn:aws:iam::905418226902:role/LabRole `
     StageName=prod2 `
   --region us-east-1

PARA TESTEAR:
 aws cloudformation describe-stacks `
  --stack-name contacts-main-2 `
  --region us-east-1 `
  --query "Stacks[0].Outputs" `
  --output table


$API = "https://xxxxx.execute-api.us-east-1.amazonaws.com/prod2"


aws apigateway get-api-keys `
  --name-query "contacts-api-key-2" `
  --include-values false `
  --region us-east-1 `
  --output table

$KEY = "xxxxx"

GET
Invoke-RestMethod -Method GET "$API/contacts" `
  -Headers @{ "x-api-key" = $KEY }

GET ONE
Invoke-RestMethod -Method GET "$API/contacts/$ID" `
  -Headers @{ "x-api-key" = $KEY }
POST

$body = @{
  name  = "Prueba Acoplada"
  email = "acoplada@example.com"
  phone = "123456789"
} | ConvertTo-Json

Invoke-RestMethod -Method POST "$API/contacts" `
  -Headers @{ "x-api-key" = $KEY } `
  -ContentType "application/json" `
  -Body $body

PUT (actualizar)
$contactId = "ID-QUE-DEVOLVIÓ-EL-POST"

$updateBody = @{
  name  = "Nombre Actualizado"
  email = "nuevo@example.com"
  phone = "987654321"
} | ConvertTo-Json

Invoke-RestMethod -Method PUT "$API/contacts/$ID" `
  -Headers @{ "x-api-key" = $KEY } `
  -ContentType "application/json" `
  -Body $updateBody

DELETE

Invoke-RestMethod -Method DELETE "$API/contacts/$ID" `
  -Headers @{ "x-api-key" = $KEY }

LANZAR DESACOPLADA.--------------------------------------------------------------------

aws ecr get-login-password --region us-east-1 `
| docker login --username AWS --password-stdin 905418226902.dkr.ecr.us-east-1.amazonaws.com

DYNAMODB------SOLO LANZAR UNA BASE DE DATOS---------

aws cloudformation deploy `
  --stack-name contacts-dynamo `
  --template-file dynamodb.yml `
  --parameter-overrides TableName=contacts `
  --region us-east-1

aws dynamodb list-tables --region us-east-1

GET_ALL IMAGE

cd "C:\Users\abelr\OneDrive\Escritorio\DESACOPLADA CN\get_all"

$env:DOCKER_BUILDKIT=0
docker build --no-cache --platform linux/amd64 -t contacts-get-all:v1 .

aws ecr create-repository --repository-name contacts-get-all --region us-east-1

docker tag contacts-get-all:v1 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-get-all:v1
docker push 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-get-all:v1



GET_ONE IMAGE

cd "C:\Users\abelr\OneDrive\Escritorio\DESACOPLADA CN\get_one"

$env:DOCKER_BUILDKIT=0
docker build --no-cache --platform linux/amd64 -t contacts-get-one:v1 .

aws ecr create-repository --repository-name contacts-get-one --region us-east-1

docker tag contacts-get-one:v1 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-get-one:v1
docker push 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-get-one:v1



POST IMAGE IMAGE

cd "C:\Users\abelr\OneDrive\Escritorio\DESACOPLADA CN\create"

$env:DOCKER_BUILDKIT=0
docker build --no-cache --platform linux/amd64 -t contacts-post:v1 .

aws ecr create-repository --repository-name contacts-create --region us-east-1

docker tag contacts-create:v1 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-create:v1
docker push 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-create:v1


UPDATE (PUT) IMAGE
cd "C:\Users\abelr\OneDrive\Escritorio\DESACOPLADA CN\update"

$env:DOCKER_BUILDKIT=0
docker build --no-cache --platform linux/amd64 -t contacts-update:v1 .

aws ecr create-repository --repository-name contacts-update --region us-east-1

docker tag contacts-update:v1 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-update:v1
docker push 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-update:v1


DELETE IMAGE

cd "C:\Users\abelr\OneDrive\Escritorio\DESACOPLADA CN\delete"

$env:DOCKER_BUILDKIT=0


aws ecr create-repository --repository-name contacts-delete --region us-east-1

docker tag contacts-delete:v1 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-delete:v1
docker push 905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-delete:v1

DEPLOY

GET_ALL GET_ONE CREATE UPDATE DELETE

aws cloudformation deploy `
  --stack-name contacts-l-get-all `
  --template-file lambda_get_all_image.yml `
  --parameter-overrides `
    TableName=contacts `
    ImageUri=905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-get-all:v1 `
    LambdaRoleArn=arn:aws:iam::905418226902:role/LabRole `
  --capabilities CAPABILITY_NAMED_IAM `
  --region us-east-1

aws cloudformation deploy `
  --stack-name contacts-l-get-one `
  --template-file lambda_get_one_image.yml `
  --parameter-overrides `
    TableName=contacts `
    ImageUri=905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-get-one:v1 `
    LambdaRoleArn=arn:aws:iam::905418226902:role/LabRole `
  --capabilities CAPABILITY_NAMED_IAM `
  --region us-east-1



aws cloudformation deploy `
  --stack-name contacts-l-post `
  --template-file lambda_post_image.yml `
  --parameter-overrides `
    TableName=contacts `
    ImageUri=905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-create:v1 `
    LambdaRoleArn=arn:aws:iam::905418226902:role/LabRole `
  --capabilities CAPABILITY_NAMED_IAM `
  --region us-east-1

aws cloudformation deploy `
  --stack-name contacts-l-update `
  --template-file lambda_update_image.yml `
  --parameter-overrides `
    TableName=contacts `
    ImageUri=905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-update:v1 `
    LambdaRoleArn=arn:aws:iam::905418226902:role/LabRole `
  --capabilities CAPABILITY_NAMED_IAM `
  --region us-east-1

aws cloudformation deploy `
  --stack-name contacts-l-delete `
  --template-file lambda_delete_image.yml `
  --parameter-overrides `
    TableName=contacts `
    ImageUri=905418226902.dkr.ecr.us-east-1.amazonaws.com/contacts-delete:v1 `
    LambdaRoleArn=arn:aws:iam::905418226902:role/LabRole `
  --capabilities CAPABILITY_NAMED_IAM `
  --region us-east-1

LANZAR API

aws cloudformation deploy `
  --stack-name contacts-l-api `
  --template-file api_gateway_lambdas.yml `
  --capabilities CAPABILITY_NAMED_IAM `
  --parameter-overrides StageName=prod-lambda `
  --region us-east-1

PROBARLO
aws cloudformation describe-stacks `
  --stack-name contacts-main-2 `
  --region us-east-1 `
  --query "Stacks[0].Outputs" `
  --output table


$API = "https://xxxxx.execute-api.us-east-1.amazonaws.com/prod2"


aws apigateway get-api-keys `
  --name-query "contacts-api-key-2" `
  --include-values false `
  --region us-east-1 `
  --output table

$KEY = "xxxxx"

GET
Invoke-RestMethod -Method GET "$API/contacts" `
  -Headers @{ "x-api-key" = $KEY }

GET ONE
Invoke-RestMethod -Method GET "$API/contacts/x" `
  -Headers @{ "x-api-key" = $KEY }
POST

$body = @{
  name  = "Prueba Acoplada"
  email = "acoplada@example.com"
  phone = "123456789"
} | ConvertTo-Json

Invoke-RestMethod -Method POST "$API/contacts" `
  -Headers @{ "x-api-key" = $KEY } `
  -ContentType "application/json" `
  -Body $body

PUT (actualizar)
$contactId = "ID-QUE-DEVOLVIÓ-EL-POST"

$updateBody = @{
  name  = "Nombre Actualizado"
  email = "nuevo@example.com"
  phone = "987654321"
} | ConvertTo-Json

Invoke-RestMethod -Method PUT "$API/contacts/$contactId" `
  -Headers @{ "x-api-key" = $KEY } `
  -ContentType "application/json" `
  -Body $updateBody

DELETE

Invoke-RestMethod -Method DELETE "$API/contacts/$contactId" `
  -Headers @{ "x-api-key" = $KEY }

